<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Experiment Log</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css" />

</head>
<body>
  <main class="container">
    <header>
      <h1>AI Experiment Log</h1>
      <p class="subtle">Multiple questions, each with a live answer log from Google Sheets (CSV publish).</p>
    </header>

    <section id="questions" class="grid-cards"></section>
  </main>

  <script>
    const QUESTIONS = [
      {
        text: "What is the largest number: 27483 or 27482?",
        sheetURL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXKtJnPba45mGoBCOkphmfIe1bS6gq3VIywNJtCcDhQYiGOHvc94LhFqkvyO1Q-pelZIzrIxv9X5KC/pub?gid=0&single=true&output=csv"
      }
    ];

    const escapeHTML = (str) => String(str)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;');

    function buildCard({ text }) {
      const article = document.createElement('article');
      article.className = 'question-card';
      article.innerHTML = `
        <header><div class="question">${escapeHTML(text)}</div></header>
        <div class="status" aria-live="polite"><span class="spinner"></span><span>Loading answersâ€¦</span></div>
        <div class="table-scroll hidden">
          <table role="grid">
            <caption>AI Answer Log (Live)</caption>
            <thead><tr><th>#</th><th>Answer</th><th>Date</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      `;
      return article;
    }

    async function fetchCSV(url) {
      const sep = url.includes('?') ? '&' : '?';
      const res = await fetch(url + sep + '_=' + Date.now());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.text();
    }

    function parseSimpleCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      return lines.slice(1).map(line => {
        const match = line.match(/^(?:\"([^\"]*)\"|([^,]*)),(.*)$/);
        if (match) return [match[1] ?? match[2] ?? '', match[3] ?? ''];
        const [a, b] = line.split(/,(.+)/);
        return [a ?? '', b ?? ''];
      });
    }

    function populateTable(article, rows) {
      const status = article.querySelector('.status');
      const scrollBox = article.querySelector('.table-scroll');
      const tbody = scrollBox.querySelector('tbody');
      tbody.innerHTML = '';

      if (!rows.length) {
        status.innerHTML = '<span>No rows yet.</span>';
        scrollBox.classList.add('hidden');
        return;
      }

      rows.forEach((row, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i + 1}</td><td>${escapeHTML(row[0])}</td><td>${escapeHTML(row[1])}</td>`;
        tbody.appendChild(tr);
      });

      status.classList.add('hidden');
      scrollBox.classList.remove('hidden');
    }

    async function loadQuestion(container, q) {
      const card = buildCard(q);
      container.appendChild(card);
      try {
        const csv = await fetchCSV(q.sheetURL);
        populateTable(card, parseSimpleCSV(csv));
      } catch (err) {
        card.querySelector('.status').innerHTML = `<span>Could not load data.</span> <small class="subtle">(${escapeHTML(err.message)})</small>`;
      }
    }

    (function init() {
      const container = document.getElementById('questions');
      QUESTIONS.forEach(q => loadQuestion(container, q));
    })();
  </script>
</body>
</html>
